name: Build Win32 tdjson.dll

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install gperf
      run: |
        choco install gperf

    - name: Update vcpkg
      run: |
        git -C C:/vcpkg pull

    - name: Install 32-bit dependencies
      run: |
        vcpkg install openssl[core]:x86-windows zlib:x86-windows
      env:
        VCPKG_ROOT: 'C:\vcpkg'

    - name: Configure CMake (Win32)
      run: |
        mkdir build32
        cd build32
        cmake -G "Visual Studio 17 2022" -A Win32 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ..

    - name: Build
      run: |
        cmake --build build32 --config Release

    # 新增：复制依赖的 DLL 到输出目录
    - name: Copy dependent DLLs
      run: |
        # vcpkg 32位依赖的安装路径
        $vcpkgBinPath = "C:\vcpkg\installed\x86-windows\bin"
        # tdjson.dll 所在目录
        $outputDir = "build32\Release"
        
        # 复制 OpenSSL 3.x 依赖
        Copy-Item "$vcpkgBinPath\libcrypto-3.dll" -Destination $outputDir
        Copy-Item "$vcpkgBinPath\libssl-3.dll" -Destination $outputDir
        
        # 复制 zlib 依赖
        Copy-Item "$vcpkgBinPath\zlib1.dll" -Destination $outputDir

    # 修改：上传时包含所有必要文件
    - name: Upload 32-bit tdjson.dll and dependencies
      uses: actions/upload-artifact@v4
      with:
        name: tdjson-win32
        path: |
          build32/Release/tdjson.dll
          build32/Release/libcrypto-3.dll
          build32/Release/libssl-3.dll
          build32/Release/zlib1.dll
