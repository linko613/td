name: é€‚é…linko613/td - æ˜“è¯­è¨€32ä½DLL

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: C:\vcpkg
      BUILD_DIR: build32
      # ä½ çš„ä»“åº“æ ¸å¿ƒè·¯å¾„ï¼ˆæ ¹æ®å®é™…ç»“æ„è°ƒæ•´ï¼‰
      TD_ROOT: td  # ä¸»CMakeLists.txtæ‰€åœ¨ç›®å½•ï¼ˆtd/CMakeLists.txtï¼‰
      TELEGRAM_SRC_DIR: td/telegram  # æºç ç›®å½•ï¼ˆå­˜æ”¾td_json_client.cppç­‰ï¼‰

    steps:
      - name: 1. æ£€å‡ºä½ çš„ä»“åº“ï¼ˆlinko613/tdï¼‰
        uses: actions/checkout@v4
        with:
          repository: linko613/td
          submodules: recursive
          fetch-depth: 0
          lfs: true

      - name: 2. å¼ºåˆ¶æ‹‰å–æ‰€æœ‰å­æ¨¡å—ï¼ˆç¡®ä¿æºç å®Œæ•´ï¼‰
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive --force
          # æ‰“å°tdç›®å½•ç»“æ„ï¼Œç¡®è®¤æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨
          Write-Host "`n===== ä½ çš„ä»“åº“tdç›®å½•æ–‡ä»¶ ====="
          Get-ChildItem -Path $env:TD_ROOT -Recurse -Depth 2 | Select-Object FullName

      - name: 3. å®šä½ä¸»CMakeLists.txtï¼ˆtd/CMakeLists.txtï¼‰
        run: |
          $cmakePath = "$env:TD_ROOT/CMakeLists.txt"
          if (-not (Test-Path $cmakePath)) {
            throw "âŒ æœªæ‰¾åˆ°$cmakePathï¼Œè¯·ç¡®è®¤ä»“åº“ç»“æ„"
          }
          echo "CMAKE_PATH=$cmakePath" >> $env:GITHUB_ENV
          Write-Host "âœ… æ‰¾åˆ°ä¸»CMakeLists.txtï¼š$cmakePath"
          # æ‰“å°æ–‡ä»¶å‰5è¡ŒéªŒè¯
          Get-Content $cmakePath -TotalCount 5

      - name: 4. åœ¨telegramæºç ç›®å½•ç”Ÿæˆ.defæ–‡ä»¶ï¼ˆå¼ºåˆ¶stdcallï¼‰
        run: |
          # ç¡®ä¿telegramæºç ç›®å½•å­˜åœ¨
          if (-not (Test-Path $env:TELEGRAM_SRC_DIR)) {
            throw "âŒ æœªæ‰¾åˆ°æºç ç›®å½•$env:TELEGRAM_SRC_DIR"
          }
          # ç”Ÿæˆ.defæ–‡ä»¶ï¼ˆæ”¾åœ¨æºç ç›®å½•ï¼Œæ–¹ä¾¿CMakeå¼•ç”¨ï¼‰
          $defPath = "$env:TELEGRAM_SRC_DIR/tdjson.def"
          @"
          LIBRARY tdjson.dll
          EXPORTS
              td_json_client_create@0
              td_json_client_destroy@4
              td_json_client_send@8
              td_json_client_receive@12
              td_json_client_execute@8
          "@ | Set-Content $defPath -Force
          echo "DEF_PATH=$defPath" >> $env:GITHUB_ENV
          Write-Host "âœ… ç”Ÿæˆ.defæ–‡ä»¶ï¼š$defPath"

      - name: 5. ä¿®æ”¹ä¸»CMakeLists.txtï¼ˆæ·»åŠ .defé“¾æ¥ï¼‰
        run: |
          $content = Get-Content $env:CMAKE_PATH -Raw
          # 1. ç§»é™¤åŸæœ‰å¯¼å‡ºå®ï¼Œé¿å…å†²çª
          $content = $content -replace 'TD_JSON_CLIENT_API', ''
          # 2. æ‰¾åˆ°tdjsonç›®æ ‡çš„add_libraryï¼Œæ·»åŠ .defæ–‡ä»¶
          $content = $content -replace '(add_library\(tdjson SHARED .*\n)(.*)', "`$1  `$<TARGET_OBJECTS:tdjson_objects>
              $env:TELEGRAM_SRC_DIR/td_json_client.cpp
              $env:DEF_PATH  # æ–°å¢.defæ–‡ä»¶
          `$2"
          # 3. å¼ºåˆ¶é“¾æ¥å™¨ä½¿ç”¨.defæ–‡ä»¶
          $content += "`n# å¼ºåˆ¶ä½¿ç”¨.defæ–‡ä»¶å¯¼å‡ºstdcallå‡½æ•°`ntarget_link_options(tdjson PRIVATE "/DEF:$env:DEF_PATH")`n"
          # å†™å›ä¿®æ”¹
          $content | Set-Content $env:CMAKE_PATH -Force
          Write-Host "âœ… å·²ä¿®æ”¹ä¸»CMakeLists.txtï¼Œæ·»åŠ .defé“¾æ¥"

      - name: 6. å®‰è£…32ä½ä¾èµ–
        run: |
          choco install gperf -y
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          git -C $env:VCPKG_ROOT checkout 2024.09.12
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          vcpkg install openssl:x86-windows zlib:x86-windows --clean-after-build

      - name: 7. é…ç½®32ä½ç¼–è¯‘
        run: |
          mkdir -p $env:BUILD_DIR
          cd $env:BUILD_DIR
          # æºç ç›®å½•æŒ‡å‘ä»“åº“æ ¹ç›®å½•ï¼ˆå› ä¸ºä¸»CMakeLists.txtåœ¨td/ä¸‹ï¼Œæ‰€ä»¥ç”¨../tdï¼‰
          cmake -G "Visual Studio 17 2022" -A Win32 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            ../$env:TD_ROOT

      - name: 8. ç¼–è¯‘tdjson.dll
        run: |
          cd $env:BUILD_DIR
          cmake --build . --config Release --target tdjson --parallel 4 --verbose

      - name: 9. éªŒè¯æ˜“è¯­è¨€å…¼å®¹æ€§ï¼ˆå¿…é¡»å¸¦@åç¼€ï¼‰
        run: |
          $dllPath = "$env:BUILD_DIR\Release\tdjson.dll"
          if (-not (Test-Path $dllPath)) { throw "âŒ DLLæœªç”Ÿæˆ" }
          
          $dumpbin = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\bin\Hostx86\x86\dumpbin.exe"
          $exports = & $dumpbin /exports $dllPath | Select-String "td_json_client_"
          $hasStdcall = $exports | Select-String "@\d+" -Quiet
          
          if (-not $hasStdcall) {
            throw "âŒ å¯¼å‡ºå‡½æ•°æ— @åç¼€ï¼å½“å‰å¯¼å‡ºï¼š`n$exports"
          } else {
            Write-Host "`nğŸ‰ æˆåŠŸç”Ÿæˆæ˜“è¯­è¨€å¯ç”¨DLLï¼å¯¼å‡ºï¼š`n$exports"
          }

      - name: 10. ä¸Šä¼ æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linko613-td-æ˜“è¯­è¨€32ä½DLL
          path: ${{ env.BUILD_DIR }}/Release/tdjson.dll
