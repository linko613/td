name: ä½ çš„ä»“åº“ä¸“å± - æ˜“è¯­è¨€32ä½tdjson.dll

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: C:\vcpkg
      BUILD_DIR: build32
      # ä½ çš„ä»“åº“ä¿¡æ¯ï¼ˆå›ºå®šï¼Œæ— éœ€ä¿®æ”¹ï¼‰
      YOUR_REPO: linko613/td
      # åŸºäºTDLibå¸¸è§„ç»“æ„ï¼Œä½ çš„ä»“åº“ä¸­telegramæ¨¡å—çš„è·¯å¾„ï¼ˆæå‰ç¡®è®¤è¿‡ï¼‰
      TARGET_TELEGRAM_DIR: td/telegram

    steps:
      - name: 1. æ£€å‡ºä½ è‡ªå·±çš„ä»“åº“ï¼ˆlinko613/tdï¼‰
        uses: actions/checkout@v4
        with:
          repository: ${{ env.YOUR_REPO }}  # ç›´æ¥æ‹‰å–ä½ çš„ä»“åº“
          submodules: recursive  # æ‹‰å–ä½ ä»“åº“é…ç½®çš„å­æ¨¡å—
          fetch-depth: 0  # å®Œæ•´æ‹‰å–ï¼Œé¿å…å­æ¨¡å—å¼•ç”¨ç¼ºå¤±
          lfs: true

      - name: 2. å¼ºåˆ¶ä¿®å¤ä½ ä»“åº“çš„å­æ¨¡å—ï¼ˆå…³é”®ï¼ï¼‰
        run: |
          # åŒæ­¥ä½ ä»“åº“çš„å­æ¨¡å—é…ç½®ï¼ˆé¿å…è¿œç¨‹åœ°å€ä¸åŒ¹é…ï¼‰
          git submodule sync --recursive
          # å¼ºåˆ¶æ‹‰å–æ‰€æœ‰å­æ¨¡å—ï¼Œè¦†ç›–æœ¬åœ°ä¸å®Œæ•´æ–‡ä»¶
          git submodule update --init --recursive --force
          
          # æ‰“å°ä½ ä»“åº“çš„æ ¹ç›®å½•ç»“æ„ï¼ˆæ–¹ä¾¿ä½ ç¡®è®¤æ–‡ä»¶ä½ç½®ï¼‰
          Write-Host "`n===== ä½ çš„ä»“åº“æ ¹ç›®å½•ç»“æ„ ====="
          Get-ChildItem -Path . -Recurse -Depth 2 | Select-Object FullName
          
          # æ‰“å°tdç›®å½•ç»“æ„ï¼ˆç¡®è®¤telegramæ˜¯å¦å­˜åœ¨ï¼‰
          Write-Host "`n===== ä½ çš„ä»“åº“tdç›®å½•ç»“æ„ ====="
          Get-ChildItem -Path ./td -Recurse -Depth 2 -ErrorAction SilentlyContinue | Select-Object FullName

      - name: 3. ç²¾å‡†å®šä½telegram/CMakeLists.txtï¼ˆä½ çš„ä»“åº“ä¸“å±è·¯å¾„ï¼‰
        run: |
          $cmakePath = "$env:TARGET_TELEGRAM_DIR/CMakeLists.txt"
          Write-Host "`næ­£åœ¨æ£€æŸ¥ä½ çš„ä»“åº“ä¸­ï¼š$cmakePath"
          
          if (Test-Path $cmakePath) {
            # æ‰¾åˆ°æ–‡ä»¶ï¼Œä¿å­˜è·¯å¾„
            echo "CMAKE_PATH=$cmakePath" >> $env:GITHUB_ENV
            echo "TELEGRAM_DIR=$env:TARGET_TELEGRAM_DIR" >> $env:GITHUB_ENV
            Write-Host "âœ… æˆåŠŸæ‰¾åˆ°ä½ ä»“åº“ä¸­çš„CMakeLists.txtï¼š$cmakePath"
            # é¢å¤–éªŒè¯ï¼šæ‰“å°æ–‡ä»¶å‰10è¡Œï¼Œè¯æ˜æ–‡ä»¶å­˜åœ¨ä¸”å®Œæ•´
            Write-Host "`næ–‡ä»¶å‰10è¡Œå†…å®¹ï¼ˆéªŒè¯å®Œæ•´æ€§ï¼‰ï¼š"
            Get-Content $cmakePath -TotalCount 10
          } else {
            # è‹¥ä»æœªæ‰¾åˆ°ï¼Œæ‰“å°è¯¦ç»†ä¿¡æ¯ä¾›ä½ æ’æŸ¥
            Write-Host "`nâŒ æœªæ‰¾åˆ°$cmakePathï¼ä½ çš„ä»“åº“tdç›®å½•ä¸‹å®é™…æ–‡ä»¶ï¼š"
            Get-ChildItem -Path ./td -ErrorAction SilentlyContinue | Select-Object Name
            throw "è¯·æ£€æŸ¥ä½ ä»“åº“ä¸­$env:TARGET_TELEGRAM_DIRæ˜¯å¦å­˜åœ¨ï¼Œæˆ–è°ƒæ•´è„šæœ¬ä¸­çš„TARGET_TELEGRAM_DIRè·¯å¾„"
          }

      - name: 4. ç”Ÿæˆæ˜“è¯­è¨€ä¸“ç”¨.defæ–‡ä»¶ï¼ˆå¼ºåˆ¶stdcallï¼‰
        run: |
          $defPath = "$env:TELEGRAM_DIR\tdjson.def"
          @"
          LIBRARY tdjson.dll
          EXPORTS
              td_json_client_create@0                ; æ˜“è¯­è¨€æ•´æ•°å‹è¿”å›
              td_json_client_destroy@4               ; 1ä¸ªæ•´æ•°å‹å‚æ•°
              td_json_client_send@8                  ; 2ä¸ªæ•´æ•°å‹å‚æ•°
              td_json_client_receive@12              ; æ•´æ•°å‹+åŒç²¾åº¦å‚æ•°
              td_json_client_execute@8               ; 2ä¸ªæ•´æ•°å‹å‚æ•°
          "@ | Set-Content $defPath -Force
          Write-Host "`nâœ… ç”Ÿæˆæ˜“è¯­è¨€é€‚é…çš„.defæ–‡ä»¶ï¼š$defPath"

      - name: 5. ä¿®æ”¹ä½ ä»“åº“çš„CMakeLists.txtï¼ˆç¡®ä¿.defç”Ÿæ•ˆï¼‰
        run: |
          $content = Get-Content $env:CMAKE_PATH -Raw
          # ç§»é™¤åŸæœ‰å¯¼å‡ºå®ï¼Œé¿å…å’Œ.defå†²çª
          $content = $content -replace 'TD_JSON_CLIENT_API', ''
          # å¼ºåˆ¶å°†.defæ–‡ä»¶åŠ å…¥ç¼–è¯‘ï¼Œç¡®ä¿å¯¼å‡ºå¸¦@åç¼€
          $content = $content -replace 'add_library\(tdjson SHARED .*\)', @"
          add_library(tdjson SHARED
              `$<TARGET_OBJECTS:tdjson_objects>
              td_json_client.cpp
              $env:TELEGRAM_DIR\tdjson.def
          )
          target_link_options(tdjson PRIVATE "/DEF:`${CMAKE_CURRENT_SOURCE_DIR}/tdjson.def")
          "@
          # å†™å›ä¿®æ”¹ï¼ˆé’ˆå¯¹ä½ ä»“åº“çš„æ–‡ä»¶ï¼‰
          $content | Set-Content $env:CMAKE_PATH -Force
          Write-Host "âœ… å·²ä¿®æ”¹ä½ ä»“åº“çš„$env:CMAKE_PATH"

      - name: 6. å®‰è£…32ä½ä¾èµ–ï¼ˆopenssl/zlibï¼‰
        run: |
          choco install gperf -y
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          git -C $env:VCPKG_ROOT checkout 2024.09.12
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          # å®‰è£…32ä½ä¾èµ–ï¼ˆæ˜“è¯­è¨€å¸¸ç”¨ï¼‰
          vcpkg install openssl:x86-windows zlib:x86-windows --clean-after-build

      - name: 7. é…ç½®32ä½ç¼–è¯‘ç¯å¢ƒ
        run: |
          mkdir -p $env:BUILD_DIR
          cd $env:BUILD_DIR
          # æŒ‡å‘ä½ ä»“åº“çš„æ ¹ç›®å½•ä½œä¸ºæºç ç›®å½•
          cmake -G "Visual Studio 17 2022" -A Win32 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release ..

      - name: 8. ç¼–è¯‘tdjson.dllï¼ˆä»…æ ¸å¿ƒç›®æ ‡ï¼Œå¿«é€Ÿå®Œæˆï¼‰
        run: |
          cd $env:BUILD_DIR
          # åªç¼–è¯‘tdjson.dllï¼Œè·³è¿‡æ— å…³æ¨¡å—ï¼ˆé¿å…å†²çªï¼‰
          cmake --build . --config Release --target tdjson --parallel 4 --verbose

      - name: 9. éªŒè¯æ˜“è¯­è¨€å…¼å®¹æ€§ï¼ˆå¿…é¡»å¸¦@åç¼€ï¼‰
        run: |
          $dllPath = "$env:BUILD_DIR\Release\tdjson.dll"
          if (-not (Test-Path $dllPath)) { throw "âŒ DLLæœªç”Ÿæˆ" }
          
          # æ£€æŸ¥å¯¼å‡ºå‡½æ•°æ˜¯å¦å¸¦@åç¼€ï¼ˆæ˜“è¯­è¨€stdcallå¿…éœ€ï¼‰
          $dumpbin = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\bin\Hostx86\x86\dumpbin.exe"
          $exports = & $dumpbin /exports $dllPath | Select-String "td_json_client_"
          $hasStdcall = $exports | Select-String "@\d+" -Quiet
          
          if (-not $hasStdcall) {
            throw "âŒ å¯¼å‡ºå‡½æ•°æ— @åç¼€ï¼æ˜“è¯­è¨€æ— æ³•è°ƒç”¨ï¼Œå½“å‰å¯¼å‡ºï¼š`n$exports"
          } else {
            Write-Host "`nğŸ‰ æˆåŠŸç”Ÿæˆä½ ä»“åº“çš„æ˜“è¯­è¨€å¯ç”¨DLLï¼"
            Write-Host "å¯¼å‡ºå‡½æ•°ï¼ˆå¸¦@åç¼€ï¼Œç¬¦åˆè¦æ±‚ï¼‰ï¼š`n$exports"
          }

      - name: 10. ä¸Šä¼ ä½ çš„æ˜“è¯­è¨€ä¸“ç”¨DLL
        uses: actions/upload-artifact@v4
        with:
          name: ä½ çš„ä»“åº“-æ˜“è¯­è¨€32ä½tdjson.dll
          path: ${{ env.BUILD_DIR }}/Release/tdjson.dll
