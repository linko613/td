name: 修复头文件路径 - 最终编译成功

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: C:\vcpkg
      BUILD_DIR: build32
      # 核心文件实际路径（你的仓库中）
      CORE_SRC: td/telegram/td_json_client.cpp  # 实现文件
      CORE_H: td/telegram/td_json_client.h      # 头文件（关键）
      DEF_FILE: tdjson.def

    steps:
      - name: 1. 检出仓库
        uses: actions/checkout@v4
        with:
          repository: linko613/td
          submodules: recursive
          fetch-depth: 0

      - name: 2. 强制拉取子模块（确保头文件存在）
        run: |
          git submodule sync td/
          git submodule update --init --force td/
          git -C td/ submodule update --init --recursive --force
          # 验证头文件和实现文件是否存在
          if (-not (Test-Path $env:CORE_SRC)) { throw "缺失实现文件：$env:CORE_SRC" }
          if (-not (Test-Path $env:CORE_H)) { throw "缺失头文件：$env:CORE_H" }
          Write-Host "✅ 核心文件存在：`n$env:CORE_SRC`n$env:CORE_H"

      - name: 3. 创建独立编译环境（修复头文件路径）
        run: |
          mkdir -p $env:BUILD_DIR
          cd $env:BUILD_DIR
          # 独立CMakeLists.txt，明确指定头文件搜索路径
          @"
          cmake_minimum_required(VERSION 3.15)
          project(tdjson)
          set(CMAKE_CXX_STANDARD 17)
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_SYSTEM_PROCESSOR x86)

          # 找到依赖
          find_package(OpenSSL REQUIRED)
          find_package(ZLIB REQUIRED)

          # 核心源码（实现文件+def）
          add_library(tdjson SHARED
              ../$env:CORE_SRC
              ../$env:DEF_FILE
          )

          # 关键：添加头文件搜索路径（让编译器找到td/telegram/td_json_client.h）
          # 仓库根目录（因为CORE_H的路径是td/telegram/...，从根目录开始查找）
          target_include_directories(tdjson PRIVATE
              ..  # 仓库根目录（包含td/目录）
              ../td/tdutils  # 其他依赖头文件
              ../td/td/generate/auto
              $ENV{VCPKG_ROOT}/installed/x86-windows/include
          )

          # 链接依赖库
          target_link_libraries(tdjson PRIVATE
              OpenSSL::SSL
              OpenSSL::Crypto
              ZLIB::ZLIB
              ws2_32
              Mswsock
              Crypt32
          )

          # 编译和链接选项
          target_compile_definitions(tdjson PRIVATE
              _WINDLL
              NOMINMAX
              WIN32_LEAN_AND_MEAN
          )
          target_link_options(tdjson PRIVATE
              /DEF:../$env:DEF_FILE
              /MACHINE:X86
          )
          "@ | Set-Content CMakeLists.txt -Force
          Write-Host "✅ 已创建独立CMake配置，修复头文件路径"

      - name: 4. 生成.def文件
        run: |
          cd $env:BUILD_DIR
          @"
          LIBRARY tdjson.dll
          EXPORTS
              td_json_client_create@0
              td_json_client_destroy@4
              td_json_client_send@8
              td_json_client_receive@12
              td_json_client_execute@8
          "@ | Set-Content ../$env:DEF_FILE -Force

      - name: 5. 修改头文件（确保导出正确）
        run: |
          $hContent = Get-Content $env:CORE_H -Raw
          # 添加导出宏和调用约定
          $hContent = $hContent -replace 'typedef struct td_json_client td_json_client;', @"
          typedef struct td_json_client td_json_client;
          #define TD_JSON_EXPORT __declspec(dllexport) __stdcall
          "@
          # 重定义函数声明（匹配实现）
          $hContent = $hContent -replace 'td_json_client \*td_json_client_create\(\);', 'TD_JSON_EXPORT td_json_client *td_json_client_create();'
          $hContent = $hContent -replace 'void td_json_client_destroy\(td_json_client \*client\);', 'TD_JSON_EXPORT void td_json_client_destroy(td_json_client *client);'
          $hContent = $hContent -replace 'void td_json_client_send\(td_json_client \*client, const char \*request\);', 'TD_JSON_EXPORT void td_json_client_send(td_json_client *client, const char *request);'
          $hContent = $hContent -replace 'const char \*td_json_client_receive\(td_json_client \*client, double timeout\);', 'TD_JSON_EXPORT const char *td_json_client_receive(td_json_client *client, double timeout);'
          $hContent = $hContent -replace 'const char \*td_json_client_execute\(td_json_client \*client, const char \*request\);', 'TD_JSON_EXPORT const char *td_json_client_execute(td_json_client *client, const char *request);'
          $hContent | Set-Content $env:CORE_H -Force

      - name: 6. 安装32位依赖
        run: |
          choco install gperf -y
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          git -C $env:VCPKG_ROOT checkout 2024.09.12
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          vcpkg install openssl:x86-windows zlib:x86-windows --clean-after-build

      - name: 7. 配置编译（指定正确路径）
        run: |
          cd $env:BUILD_DIR
          cmake -G "Visual Studio 17 2022" -A Win32 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            .

      - name: 8. 编译tdjson.dll
        run: |
          cd $env:BUILD_DIR
          cmake --build . --config Release --parallel 4 --verbose

      - name: 9. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: 头文件修复后DLL
          path: ${{ env.BUILD_DIR }}/Release/tdjson.dll
