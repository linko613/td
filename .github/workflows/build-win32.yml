name: é€‚é…linko613/td - æ˜“è¯­è¨€32ä½DLLï¼ˆæœ€ç»ˆç‰ˆï¼‰

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: C:\vcpkg
      BUILD_DIR: build32
      # åŸºäºé¡¹ç›®å®é™…ç»“æ„çš„è·¯å¾„ï¼ˆä»ä½ çš„ä»“åº“æ–‡ä»¶æ ‘ç¡®è®¤ï¼‰
      PROJECT_ROOT: .  # ä»“åº“æ ¹ç›®å½•
      MAIN_CMAKE: td/CMakeLists.txt  # ä¸»CMakeé…ç½®æ–‡ä»¶ï¼ˆtdæ ¹ç›®å½•ä¸‹ï¼‰
      TELEGRAM_SRC: td/telegram  # telegramæºç ç›®å½•ï¼ˆå­˜æ”¾td_json_clientç›¸å…³æ–‡ä»¶ï¼‰

    steps:
      - name: 1. æ£€å‡ºä½ çš„ä»“åº“ï¼ˆlinko613/tdï¼‰
        uses: actions/checkout@v4
        with:
          repository: linko613/td
          submodules: recursive  # æ‹‰å–æ‰€æœ‰å­æ¨¡å—ï¼ˆé¡¹ç›®ä¾èµ–ï¼‰
          fetch-depth: 0  # å®Œæ•´æ‹‰å–ä»£ç ï¼Œé¿å…å­æ¨¡å—å¼•ç”¨ç¼ºå¤±

      - name: 2. å¼ºåˆ¶ä¿®å¤å­æ¨¡å—ï¼ˆç¡®ä¿æºç å®Œæ•´ï¼‰
        run: |
          # åŒæ­¥å­æ¨¡å—é…ç½®ï¼ˆè§£å†³è¿œç¨‹åœ°å€å˜æ›´é—®é¢˜ï¼‰
          git submodule sync --recursive
          # å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å­æ¨¡å—ï¼Œè¦†ç›–ä¸å®Œæ•´æ–‡ä»¶
          git submodule update --init --recursive --force
          # æ‰“å°é¡¹ç›®æ ¸å¿ƒç›®å½•ç»“æ„ï¼ˆä¾›éªŒè¯ï¼‰
          Write-Host "`n===== ä»“åº“æ ¸å¿ƒç›®å½•ç»“æ„ ====="
          Get-ChildItem -Path $env:PROJECT_ROOT -Recurse -Include "CMakeLists.txt", "telegram" | Select-Object FullName

      - name: 3. ç¡®è®¤ä¸»CMakeLists.txtå­˜åœ¨ï¼ˆåŸºäºå®é™…ç»“æ„ï¼‰
        run: |
          if (-not (Test-Path $env:MAIN_CMAKE)) {
            throw "âŒ æœªæ‰¾åˆ°ä¸»CMakeé…ç½®æ–‡ä»¶ï¼š$env:MAIN_CMAKEï¼Œè¯·æ£€æŸ¥é¡¹ç›®ç»“æ„"
          }
          Write-Host "âœ… ç¡®è®¤å­˜åœ¨ä¸»CMakeLists.txtï¼š$env:MAIN_CMAKE"
          # æ‰“å°ä¸»CMakeå‰5è¡Œï¼ˆéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼‰
          Get-Content $env:MAIN_CMAKE -TotalCount 5

      - name: 4. ç¡®è®¤telegramæºç ç›®å½•å­˜åœ¨ï¼ˆåŸºäºå®é™…ç»“æ„ï¼‰
        run: |
          if (-not (Test-Path $env:TELEGRAM_SRC)) {
            throw "âŒ æœªæ‰¾åˆ°telegramæºç ç›®å½•ï¼š$env:TELEGRAM_SRCï¼Œè¯·æ£€æŸ¥é¡¹ç›®ç»“æ„"
          }
          Write-Host "âœ… ç¡®è®¤å­˜åœ¨telegramæºç ç›®å½•ï¼š$env:TELEGRAM_SRC"
          # æ‰“å°ç›®å½•ä¸‹çš„æ ¸å¿ƒæ–‡ä»¶ï¼ˆç¡®è®¤td_json_client.cppå­˜åœ¨ï¼‰
          Get-ChildItem -Path $env:TELEGRAM_SRC -Filter "td_json_client*" | Select-Object Name

      - name: 5. åœ¨telegramç›®å½•ç”Ÿæˆæ˜“è¯­è¨€ä¸“ç”¨.defæ–‡ä»¶
        run: |
          $defPath = "$env:TELEGRAM_SRC/tdjson.def"
          @"
          LIBRARY tdjson.dll
          EXPORTS
              td_json_client_create@0                ; æ— å‚æ•°ï¼ˆè¿”å›å®¢æˆ·ç«¯æŒ‡é’ˆï¼‰
              td_json_client_destroy@4               ; å‚æ•°ï¼šclientï¼ˆæŒ‡é’ˆï¼Œ4å­—èŠ‚ï¼‰
              td_json_client_send@8                  ; å‚æ•°ï¼šclientï¼ˆ4ï¼‰+ requestï¼ˆ4ï¼‰
              td_json_client_receive@12              ; å‚æ•°ï¼šclientï¼ˆ4ï¼‰+ timeoutï¼ˆ8ï¼‰
              td_json_client_execute@8               ; å‚æ•°ï¼šclientï¼ˆ4ï¼‰+ requestï¼ˆ4ï¼‰
          "@ | Set-Content $defPath -Force
          Write-Host "âœ… ç”Ÿæˆ.defæ–‡ä»¶ï¼š$defPath"
          echo "DEF_PATH=$defPath" >> $env:GITHUB_ENV

      - name: 6. ä¿®æ”¹ä¸»CMakeLists.txtï¼ˆæ·»åŠ .defæ–‡ä»¶é“¾æ¥ï¼‰
        run: |
          $content = Get-Content $env:MAIN_CMAKE -Raw
          # ç§»é™¤åŸæœ‰å¯¼å‡ºå®ï¼Œé¿å…ä¸.defå†²çª
          $content = $content -replace 'TD_JSON_CLIENT_API', ''
          # åœ¨tdjsonç›®æ ‡ä¸­æ·»åŠ .defæ–‡ä»¶
          $content = $content -replace '(add_library\(tdjson SHARED)(.*?)(\))', "`$1`$2`n    $env:DEF_PATH`$3"
          # å¼ºåˆ¶é“¾æ¥å™¨ä½¿ç”¨.defæ–‡ä»¶ï¼ˆç¡®ä¿å¯¼å‡ºå¸¦@åç¼€ï¼‰
          $content += "`n# æ˜“è¯­è¨€é€‚é…ï¼šå¼ºåˆ¶ä½¿ç”¨.defæ–‡ä»¶å¯¼å‡ºstdcallå‡½æ•°`ntarget_link_options(tdjson PRIVATE "/DEF:$env:DEF_PATH")`n"
          # å†™å›ä¿®æ”¹
          $content | Set-Content $env:MAIN_CMAKE -Force
          Write-Host "âœ… å·²ä¿®æ”¹ä¸»CMakeLists.txtï¼Œæ·»åŠ .defæ–‡ä»¶å¼•ç”¨"

      - name: 7. å®‰è£…32ä½ä¾èµ–ï¼ˆopenssl/zlibï¼‰
        run: |
          # å®‰è£…TDLibç¼–è¯‘å¿…éœ€çš„gperfå·¥å…·
          choco install gperf -y
          # å®‰è£…vcpkgå¹¶åˆå§‹åŒ–
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          git -C $env:VCPKG_ROOT checkout 2024.09.12  # ç¨³å®šç‰ˆæœ¬
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          # å®‰è£…32ä½ä¾èµ–ï¼ˆæ˜“è¯­è¨€å¸¸ç”¨ï¼‰
          vcpkg install openssl:x86-windows zlib:x86-windows --clean-after-build

      - name: 8. é…ç½®32ä½ç¼–è¯‘ç¯å¢ƒ
        run: |
          # åˆ›å»ºç¼–è¯‘ç›®å½•
          mkdir -p $env:BUILD_DIR
          cd $env:BUILD_DIR
          # æŒ‡å‘ä¸»CMakeLists.txtæ‰€åœ¨ç›®å½•ï¼ˆtd/ï¼‰
          cmake -G "Visual Studio 17 2022" -A Win32 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            ../td  # æºç ç›®å½•ä¸ºtd/ï¼ˆä¸»CMakeæ‰€åœ¨ç›®å½•ï¼‰

      - name: 9. ç¼–è¯‘tdjson.dllï¼ˆæ ¸å¿ƒç›®æ ‡ï¼‰
        run: |
          cd $env:BUILD_DIR
          # å¹¶è¡Œç¼–è¯‘ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—
          cmake --build . --config Release --target tdjson --parallel 4 --verbose

      - name: 10. éªŒè¯æ˜“è¯­è¨€å…¼å®¹æ€§ï¼ˆå¿…é¡»å¸¦@åç¼€ï¼‰
        run: |
          $dllPath = "$env:BUILD_DIR\Release\tdjson.dll"
          if (-not (Test-Path $dllPath)) {
            throw "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆtdjson.dll"
          }
          # æ£€æŸ¥å¯¼å‡ºå‡½æ•°æ˜¯å¦å¸¦@åç¼€ï¼ˆstdcallç‰¹å¾ï¼‰
          $dumpbin = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\bin\Hostx86\x86\dumpbin.exe"
          $exports = & $dumpbin /exports $dllPath | Select-String "td_json_client_"
          $hasStdcall = $exports | Select-String "@\d+" -Quiet
          if (-not $hasStdcall) {
            throw "âŒ å¯¼å‡ºå‡½æ•°ä¸ç¬¦åˆæ˜“è¯­è¨€è¦æ±‚ï¼ˆæ— @åç¼€ï¼‰ï¼Œå½“å‰å¯¼å‡ºï¼š`n$exports"
          } else {
            Write-Host "`nğŸ‰ æˆåŠŸç”Ÿæˆæ˜“è¯­è¨€å¯ç”¨çš„32ä½DLLï¼å¯¼å‡ºå‡½æ•°ï¼š`n$exports"
          }

      - name: 11. ä¸Šä¼ æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linko613-td-æ˜“è¯­è¨€32ä½å¯ç”¨DLL
          path: ${{ env.BUILD_DIR }}/Release/tdjson.dll
